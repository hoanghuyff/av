-- Tạo một namespace độc lập hoàn toàn
local SafeAutoFriend = {}

-- Wrap toàn bộ chức năng trong một function riêng
function SafeAutoFriend.Initialize()
    -- Tạo services với tên khác để tránh xung đột
    local PlayerService = game:GetService('Players')
    local MyPlayer = PlayerService.LocalPlayer
    
    -- Tạo các biến cấu hình trong namespace riêng
    SafeAutoFriend.Config = {
        SendEnabled = true,
        AcceptEnabled = true,
        SendDelay = 1,
        CheckInterval = 300,
        MaxFriends = 200
    }
    
    -- Lưu trữ riêng
    local SentList = {}
    
    -- Functions với tên độc nhất
    local function SafeCheckFriend(player)
        local success, isFriend = pcall(function()
            return MyPlayer:IsFriendsWith(player.UserId)
        end)
        return success and isFriend or false
    end
    
    local function SafeGetFriendCount()
        local success, count = pcall(function()
            return #MyPlayer:GetFriendsOnline()
        end)
        return success and count or 0
    end
    
    -- Hàm gửi yêu cầu an toàn
    local function SafeSendRequest(player)
        if not player or typeof(player) ~= "Instance" or not player:IsA("Player") then
            return false
        end
        
        -- Kiểm tra các điều kiện
        if SentList[player.Name] or SafeCheckFriend(player) then
            return false
        end
        
        local success = pcall(function()
            task.wait(0.5) -- Đợi ngắn để tránh xung đột
            MyPlayer:RequestFriendship(player)
        end)
        
        if success then
            SentList[player.Name] = true
            print("✅ [Safe] Đã gửi yêu cầu kết bạn tới:", player.Name)
        end
        
        return success
    end
    
    -- Auto Accept riêng biệt
    local function SafeAutoAccept()
        while SafeAutoFriend.Config.AcceptEnabled do
            pcall(function()
                if SafeGetFriendCount() < SafeAutoFriend.Config.MaxFriends then
                    local requests = MyPlayer:GetFriendRequests()
                    for _, request in ipairs(requests) do
                        task.wait(1.5) -- Đợi lâu hơn để tránh xung đột
                        pcall(function()
                            MyPlayer:RequestFriendship(request)
                        end)
                        print("✅ [Safe] Đã chấp nhận kết bạn từ:", request.Name)
                    end
                end
            end)
            task.wait(10)
        end
    end
    
    -- Auto Send riêng biệt
    local function SafeAutoSend()
        while SafeAutoFriend.Config.SendEnabled do
            pcall(function()
                if SafeGetFriendCount() < SafeAutoFriend.Config.MaxFriends then
                    for _, player in ipairs(PlayerService:GetPlayers()) do
                        if player ~= MyPlayer then
                            SafeSendRequest(player)
                            task.wait(SafeAutoFriend.Config.SendDelay)
                        end
                    end
                end
            end)
            task.wait(SafeAutoFriend.Config.CheckInterval)
        end
    end
    
    -- PlayerAdded với delay an toàn
    PlayerService.PlayerAdded:Connect(function(player)
        task.wait(2) -- Đợi để tránh xung đột với script khác
        if SafeAutoFriend.Config.SendEnabled then
            SafeSendRequest(player)
        end
    end)
    
    -- Hàm Start/Stop an toàn
    function SafeAutoFriend:Start()
        if self.Running then return end
        self.Running = true
        
        -- Khởi động với delay
        task.wait(5) -- Đợi các script khác chạy xong
        print("🚀 [Safe] Auto Friend đang khởi động...")
        
        -- Spawn riêng biệt
        task.spawn(SafeAutoSend)
        task.wait(2)
        task.spawn(SafeAutoAccept)
        
        print("✨ [Safe] Auto Friend đã khởi động!")
    end
    
    function SafeAutoFriend:Stop()
        self.Running = false
        self.Config.SendEnabled = false
        self.Config.AcceptEnabled = false
        print("🛑 [Safe] Auto Friend đã dừng!")
    end
    
    return SafeAutoFriend
end

-- Khởi tạo trong môi trường riêng
local success, AutoFriendInstance = pcall(SafeAutoFriend.Initialize)

if success and AutoFriendInstance then
    -- Lưu instance vào biến global với tên độc nhất
    _G.SafeAutoFriendV2 = AutoFriendInstance
    
    -- Khởi động với delay
    task.wait(10) -- Đợi thêm thời gian để script khác chạy xong
    AutoFriendInstance:Start()
else
    warn("❌ Không thể khởi tạo Safe Auto Friend!")
end
