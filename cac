-- Kiểm tra xem script đã được chạy chưa
if _G.AutoFriendInitialized then
    warn("⚠️ Auto Friend script đã được khởi chạy!")
    return
end

local Players = game:GetService('Players')
local Client = Players.LocalPlayer

-- Đánh dấu script đã được khởi tạo
_G.AutoFriendInitialized = true

-- Cấu hình (sử dụng bảng cấu hình riêng để tránh xung đột)
local Config = {
    EnableFriendRequest = true,
    EnableAutoAccept = true,
    WaitToSendFriend = 300,
    RequestDelay = 1,
    MaxFriends = 200
}

-- Tạo namespace riêng để tránh xung đột biến toàn cục
local AutoFriend = {
    AlreadySent = {},
    Running = false
}

-- Các hàm tiện ích
function AutoFriend:IsAlreadyFriend(player)
    local success, result = pcall(function()
        return Client:IsFriendsWith(player.UserId)
    end)
    return success and result or false
end

function AutoFriend:GetFriendCount()
    local success, count = pcall(function()
        return #Client:GetFriendsOnline()
    end)
    return success and count or 0
end

-- Hàm gửi yêu cầu kết bạn
function AutoFriend:SendRequest(player)
    if not player or not player.UserId then return false end
    
    local success = pcall(function()
        Client:RequestFriendship(player)
    end)
    
    if success then
        self.AlreadySent[player.Name] = true
        print("✅ Gửi yêu cầu kết bạn tới:", player.Name)
    end
    
    return success
end

-- Hàm tự động chấp nhận
function AutoFriend:StartAutoAccept()
    if self.AcceptRunning then return end
    self.AcceptRunning = true
    
    task.spawn(function()
        while Config.EnableAutoAccept and self.AcceptRunning do
            pcall(function()
                local requests = Client:GetFriendRequests()
                for _, request in ipairs(requests) do
                    if self:GetFriendCount() < Config.MaxFriends then
                        pcall(function()
                            Client:RequestFriendship(request)
                        end)
                        print("✅ Chấp nhận kết bạn từ:", request.Name)
                        task.wait(1)
                    end
                end
            end)
            task.wait(5)
        end
    end)
end

-- Hàm tự động gửi yêu cầu
function AutoFriend:StartAutoSend()
    if self.SendRunning then return end
    self.SendRunning = true
    
    task.spawn(function()
        while Config.EnableFriendRequest and self.SendRunning do
            if self:GetFriendCount() < Config.MaxFriends then
                for _, player in ipairs(Players:GetPlayers()) do
                    if player ~= Client 
                        and not self.AlreadySent[player.Name] 
                        and not self:IsAlreadyFriend(player) 
                    then
                        self:SendRequest(player)
                        task.wait(Config.RequestDelay)
                    end
                end
            end
            task.wait(Config.WaitToSendFriend)
        end
    end)
end

-- Xử lý người chơi mới
Players.PlayerAdded:Connect(function(player)
    if Config.EnableFriendRequest 
        and not AutoFriend.AlreadySent[player.Name] 
        and not AutoFriend:IsAlreadyFriend(player)
        and AutoFriend:GetFriendCount() < Config.MaxFriends 
    then
        task.wait(Config.RequestDelay)
        AutoFriend:SendRequest(player)
    end
end)

-- Hàm dừng script
function AutoFriend:Stop()
    self.SendRunning = false
    self.AcceptRunning = false
    print("🛑 Auto Friend đã dừng!")
end

-- Hàm khởi động script
function AutoFriend:Start()
    if self.Running then return end
    self.Running = true
    
    print("🚀 Auto Friend đang khởi động...")
    self:StartAutoSend()
    self:StartAutoAccept()
    
    print("✨ Auto Friend đã khởi động thành công!")
    print("➡️ Auto Send:", Config.EnableFriendRequest and "Bật" or "Tắt")
    print("➡️ Auto Accept:", Config.EnableAutoAccept and "Bật" or "Tắt")
end

-- Tạo backup để có thể truy cập sau này
_G.AutoFriend = AutoFriend

-- Khởi động script
AutoFriend:Start()
